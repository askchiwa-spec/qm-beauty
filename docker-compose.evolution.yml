# ============================================
# EVOLUTION API - DOCKER COMPOSE
# ============================================
# Self-hosted WhatsApp API for QM Beauty
# Docs: https://doc.evolution-api.com

version: '3.8'

services:
  evolution-api:
    container_name: qm-beauty-whatsapp
    image: atendai/evolution-api:latest
    restart: always
    ports:
      - "8080:8080"
    environment:
      # ============================================
      # API AUTHENTICATION
      # ============================================
      # Change this to a strong random key
      AUTHENTICATION_API_KEY: ${EVOLUTION_API_KEY:-change-me-to-strong-password}
      
      # ============================================
      # SERVER CONFIGURATION
      # ============================================
      SERVER_TYPE: http
      SERVER_PORT: 8080
      SERVER_URL: ${EVOLUTION_API_URL:-http://localhost:8080}
      
      # ============================================
      # CORS SETTINGS
      # ============================================
      CORS_ORIGIN: '*'
      CORS_METHODS: 'POST,GET,PUT,DELETE'
      CORS_CREDENTIALS: 'true'
      
      # ============================================
      # DATABASE (PostgreSQL) - OPTIONAL
      # ============================================
      # Uncomment to use PostgreSQL for persistence
      # DATABASE_ENABLED: 'true'
      # DATABASE_PROVIDER: 'postgresql'
      # DATABASE_CONNECTION_URI: 'postgresql://user:password@postgres:5432/evolution'
      # DATABASE_CONNECTION_CLIENT_NAME: 'evolution_client'
      # DATABASE_SAVE_DATA_INSTANCE: 'true'
      # DATABASE_SAVE_DATA_NEW_MESSAGE: 'true'
      # DATABASE_SAVE_MESSAGE_UPDATE: 'true'
      # DATABASE_SAVE_DATA_CONTACTS: 'true'
      # DATABASE_SAVE_DATA_CHATS: 'true'
      
      # ============================================
      # REDIS CACHE - OPTIONAL
      # ============================================
      # Uncomment to use Redis for caching
      # CACHE_REDIS_ENABLED: 'true'
      # CACHE_REDIS_URI: 'redis://redis:6379'
      # CACHE_REDIS_PREFIX_KEY: 'evolution'
      # CACHE_LOCAL_ENABLED: 'false'
      
      # ============================================
      # WEBHOOK SETTINGS
      # ============================================
      WEBHOOK_GLOBAL_ENABLED: 'true'
      WEBHOOK_GLOBAL_URL: '${NEXT_PUBLIC_APP_URL}/api/whatsapp/webhook'
      WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS: 'true'
      
      # Events to listen for
      WEBHOOK_EVENTS_APPLICATION_STARTUP: 'false'
      WEBHOOK_EVENTS_QRCODE_UPDATED: 'true'
      WEBHOOK_EVENTS_MESSAGES_SET: 'true'
      WEBHOOK_EVENTS_MESSAGES_UPSERT: 'true'
      WEBHOOK_EVENTS_MESSAGES_UPDATE: 'true'
      WEBHOOK_EVENTS_MESSAGES_DELETE: 'false'
      WEBHOOK_EVENTS_SEND_MESSAGE: 'true'
      WEBHOOK_EVENTS_CONTACTS_SET: 'false'
      WEBHOOK_EVENTS_CONTACTS_UPSERT: 'false'
      WEBHOOK_EVENTS_CONTACTS_UPDATE: 'false'
      WEBHOOK_EVENTS_PRESENCE_UPDATE: 'false'
      WEBHOOK_EVENTS_CHATS_SET: 'false'
      WEBHOOK_EVENTS_CHATS_UPSERT: 'false'
      WEBHOOK_EVENTS_CHATS_UPDATE: 'false'
      WEBHOOK_EVENTS_CHATS_DELETE: 'false'
      WEBHOOK_EVENTS_GROUPS_UPSERT: 'false'
      WEBHOOK_EVENTS_GROUPS_UPDATE: 'false'
      WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE: 'false'
      WEBHOOK_EVENTS_CONNECTION_UPDATE: 'true'
      WEBHOOK_EVENTS_CALL: 'false'
      WEBHOOK_EVENTS_NEW_JWT_TOKEN: 'false'
      
      # ============================================
      # INSTANCE SETTINGS
      # ============================================
      CONFIG_SESSION_PHONE_CLIENT: 'QM Beauty Tanzania'
      CONFIG_SESSION_PHONE_NAME: 'Chrome'
      DEL_INSTANCE: 'false'
      
      # ============================================
      # CHATWOOT INTEGRATION - OPTIONAL
      # ============================================
      # CHATWOOT_ENABLED: 'false'
      # CHATWOOT_BASE_URL: 'https://app.chatwoot.com'
      # CHATWOOT_API_KEY: 'your-chatwoot-api-key'
      
      # ============================================
      # LOGGING
      # ============================================
      LOG_LEVEL: 'ERROR,WARN,DEBUG,INFO,LOG,VERBOSE,DARK,WEBHOOKS'
      LOG_COLOR: 'true'
      LOG_BAILEYS: 'error'
      
    volumes:
      # Persistent storage for WhatsApp sessions
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    
    networks:
      - qm-beauty-network

  # ============================================
  # POSTGRESQL DATABASE (OPTIONAL)
  # ============================================
  # Uncomment to enable database persistence
  # postgres:
  #   container_name: qm-beauty-postgres
  #   image: postgres:15-alpine
  #   restart: always
  #   environment:
  #     POSTGRES_USER: evolution
  #     POSTGRES_PASSWORD: change-me-strong-password
  #     POSTGRES_DB: evolution
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - qm-beauty-network

  # ============================================
  # REDIS CACHE (OPTIONAL)
  # ============================================
  # Uncomment to enable Redis caching
  # redis:
  #   container_name: qm-beauty-redis
  #   image: redis:7-alpine
  #   restart: always
  #   command: redis-server --appendonly yes
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - qm-beauty-network

volumes:
  evolution_instances:
  evolution_store:
  # postgres_data:
  # redis_data:

networks:
  qm-beauty-network:
    driver: bridge
